on:
  push:
    branches:
      - master
      - main

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Extract Metadata
        id: meta
        shell: bash
        run: |
          FILE=$(grep -rl --include="*.cs" "public const string PLUGIN_NAME" . | head -n 1)

          NAME=$(sed -n 's/.*PLUGIN_NAME *= *"\([^"]*\)".*/\1/p' "$FILE")
          GUID=$(sed -n 's/.*PLUGIN_GUID *= *"\([^"]*\)".*/\1/p' "$FILE")
          VERSION=$(sed -n 's/.*PLUGIN_VERSION *= *"\([^"]*\)".*/\1/p' "$FILE")

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "guid=$GUID" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "Detected:"
          echo "  PLUGIN_NAME     = $NAME"
          echo "  PLUGIN_GUID     = $GUID"
          echo "  PLUGIN_VERSION  = $VERSION"
          
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2
        
      - name: Install .NET Framework Targeting Pack 4.8
        run: |
          choco install netfx-4.8-devpack -y
          
      - name: Build
        run: |
          msbuild /t:Rebuild /p:Configuration=Release
          
      - name: Package mod
        shell: bash
        run: |
          MOD_NAME="${{ steps.meta.outputs.name }}"
          VERSION="${{ steps.meta.outputs.version }}"

          OUTDIR="release/${MOD_NAME}_v${VERSION}/BepInEx/plugins"
          mkdir -p "$OUTDIR"

          # Find DLL (Release output)
          DLL=$(find . -path "*bin/Release*" -name "${MOD_NAME}.dll" | head -n 1)

          cp "$DLL" "$OUTDIR/"

          cd release
          zip -r "${MOD_NAME}_v${VERSION}.zip" "${MOD_NAME}_v${VERSION}"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/${{ steps.meta.outputs.name }}_v${{ steps.meta.outputs.version }}.zip
          tag_name: ${{ github.ref_name }}
          name: "${{ steps.meta.outputs.name }} v${{ steps.meta.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}